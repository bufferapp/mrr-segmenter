---
title: "MRR Segmenter"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    theme: paper
runtime: shiny
---

```{r setup, include = FALSE}
library(flexdashboard)
library(ggplot2)
library(scales)

# access helper functions
source("mrr_source.R")

# get mrr data from Redshift or CSV
mrr <- get_mrr_data() 
```


Column {.sidebar}
-----------------------------------------------------------------------

Choose what to segment MRR by. Total MRR will be grouped by the selected choices so that you can how MRR has changed over time for each combination.

```{r}
checkboxGroupInput('segments', label = 'Segment By:',
                    choices = c('Plan Type' = 'simplified_plan_id',
                          'Billing Interval' = 'billing_interval',
                          'Gateway' = 'gateway'), 
                   selected = c('simplified_plan_id', 'billing_interval', 'gateway'))
```


Column
-----------------------------------------------------------------------

### MRR Plot

```{r}
# combine the selected variables into a new data frame
selected_data <- reactive({
  
  # if there are no choices checked
  if (length(input$segments) == 0) {
    
    mrr <- mrr %>% 
      group_by(date) %>% 
      summarise(mrr = sum(mrr)) %>% 
      mutate(segment = 'Total MRR (Excluding Manual Payments)')
    
  } else {
    mrr <- mrr[, c("date", input$segments, "mrr")]
    
    groups <- mrr %>%
    select(-date, -mrr)
    
    group_args <- c(groups, sep="_")
    group_values <- do.call(paste, group_args)

    mrr$segment <- group_values
    
  }

  mrr

})

renderPlot({

  p <- selected_data() %>% 
    group_by(date, segment) %>%
    summarise(mrr = sum(mrr)) %>%
    ungroup() %>%
    mutate(segment = reorder(segment, -mrr)) %>%
    ggplot(aes_string(x = 'date', y = 'mrr')) +
    geom_line() +
    stat_smooth(method = 'loess') +
    facet_wrap(~ segment, scales = "free_y", ncol = 3) +
    scale_y_continuous(labels = dollar) +
    labs(x = NULL, y = NULL, title = NULL) +
    theme(legend.position = "none")
  p

})
```
